
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Doungdara Keut</title>
  <meta name="author" content="Doungdara Keut">

  
  <meta name="description" content="1 What is Active Record?Active Record is the M in MVC - the
model - which is the layer of the system responsible for representing business
data and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://github.com/doungdara/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Doungdara Keut" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Doungdara Keut</a></h1>
  
    <h2 class="header-profile-sub-title">Ruby On Rails, and ASP.Net Developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:github.com/doungdara" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/11/active-record-basic/">Active Record Basic</a></h1>
    
    
      <p class="meta">
        








  





<time datetime="2015-12-11T17:23:33+07:00" pubdate data-updated="true"><time class='entry-date' datetime='2015-12-11T17:23:33+07:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:23 pm</span></time></time>
        
      </p>
    
  </header>


  <div class="entry-content"><div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="what-is-active-record-questionmark">1 What is Active Record?</h3><p>Active Record is the M in <a href="getting_started.html#the-mvc-architecture">MVC</a> - the
model - which is the layer of the system responsible for representing business
data and logic. Active Record facilitates the creation and use of business
objects whose data requires persistent storage to a database. It is an
implementation of the Active Record pattern which itself is a description of an
Object Relational Mapping system.</p><h4 id="the-active-record-pattern">1.1 The Active Record Pattern</h4><p><a href="http://www.martinfowler.com/eaaCatalog/activeRecord.html">Active Record was described by Martin Fowler</a>
in his book <em>Patterns of Enterprise Application Architecture</em>. In
Active Record, objects carry both persistent data and behavior which
operates on that data. Active Record takes the opinion that ensuring
data access logic as part of the object will educate users of that
object on how to write to and read from the database.</p><h4 id="object-relational-mapping">1.2 Object Relational Mapping</h4><p>Object-Relational Mapping, commonly referred to as its abbreviation ORM, is
a technique that connects the rich objects of an application to tables in
a relational database management system. Using ORM, the properties and
relationships of the objects in an application can be easily stored and
retrieved from a database without writing SQL statements directly and with less
overall database access code.</p><h4 id="active-record-as-an-orm-framework">1.3 Active Record as an ORM Framework</h4><p>Active Record gives us several mechanisms, the most important being the ability
to:</p>
<ul>
<li>Represent models and their data.</li>
<li>Represent associations between these models.</li>
<li>Represent inheritance hierarchies through related models.</li>
<li>Validate models before they get persisted to the database.</li>
<li>Perform database operations in an object-oriented fashion.</li>
</ul>
<h3 id="convention-over-configuration-in-active-record">2 Convention over Configuration in Active Record</h3><p>When writing applications using other programming languages or frameworks, it
may be necessary to write a lot of configuration code. This is particularly true
for ORM frameworks in general. However, if you follow the conventions adopted by
Rails, you'll need to write very little configuration (in some case no
configuration at all) when creating Active Record models. The idea is that if
you configure your applications in the very same way most of the time then this
should be the default way. Thus, explicit configuration would be needed
only in those cases where you can't follow the standard convention.</p><h4 id="naming-conventions">2.1 Naming Conventions</h4><p>By default, Active Record uses some naming conventions to find out how the
mapping between models and database tables should be created. Rails will
pluralize your class names to find the respective database table. So, for
a class <code>Book</code>, you should have a database table called <strong>books</strong>. The Rails
pluralization mechanisms are very powerful, being capable to pluralize (and
singularize) both regular and irregular words. When using class names composed
of two or more words, the model class name should follow the Ruby conventions,
using the CamelCase form, while the table name must contain the words separated
by underscores. Examples:</p>
<ul>
<li>Database Table - Plural with underscores separating words (e.g., <code>book_clubs</code>).</li>
<li>Model Class - Singular with the first letter of each word capitalized (e.g.,
<code>BookClub</code>).</li>
</ul>

<table class="responsive">
<thead>
<tr>
<th>Model / Class</th>
<th>Table / Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Article</code></td>
<td><code>articles</code></td>
</tr>
<tr>
<td><code>LineItem</code></td>
<td><code>line_items</code></td>
</tr>
<tr>
<td><code>Deer</code></td>
<td><code>deers</code></td>
</tr>
<tr>
<td><code>Mouse</code></td>
<td><code>mice</code></td>
</tr>
<tr>
<td><code>Person</code></td>
<td><code>people</code></td>
</tr>
</tbody>
</table>
<h4 id="schema-conventions">2.2 Schema Conventions</h4><p>Active Record uses naming conventions for the columns in database tables,
depending on the purpose of these columns.</p>
<ul>
<li>
<strong>Foreign keys</strong> - These fields should be named following the pattern
<code>singularized_table_name_id</code> (e.g., <code>item_id</code>, <code>order_id</code>). These are the
fields that Active Record will look for when you create associations between
your models.</li>
<li>
<strong>Primary keys</strong> - By default, Active Record will use an integer column named
<code>id</code> as the table's primary key. When using <a href="migrations.html">Active Record
Migrations</a> to create your tables, this column will be
automatically created.</li>
</ul>
<p>There are also some optional column names that will add additional features
to Active Record instances:</p>
<ul>
<li>
<code>created_at</code> - Automatically gets set to the current date and time when the
record is first created.</li>
<li>
<code>updated_at</code> - Automatically gets set to the current date and time whenever
the record is updated.</li>
<li>
<code>lock_version</code> - Adds <a href="http://api.rubyonrails.org/classes/ActiveRecord/Locking.html">optimistic
locking</a> to
a model.</li>
<li>
<code>type</code> - Specifies that the model uses <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html#class-ActiveRecord::Base-label-Single+table+inheritance">Single Table
Inheritance</a>.</li>
<li>
<code>(association_name)_type</code> - Stores the type for
<a href="association_basics.html#polymorphic-associations">polymorphic associations</a>.</li>
<li>
<code>(table_name)_count</code> - Used to cache the number of belonging objects on
associations. For example, a <code>comments_count</code> column in a <code>Articles</code> class that
has many instances of <code>Comment</code> will cache the number of existent comments
for each article.</li>
</ul>
<div class="note"><p>While these column names are optional, they are in fact reserved by Active Record. Steer clear of reserved keywords unless you want the extra functionality. For example, <code>type</code> is a reserved keyword used to designate a table using Single Table Inheritance (STI). If you are not using STI, try an analogous keyword like "context", that may still accurately describe the data you are modeling.</p></div><h3 id="creating-active-record-models">3 Creating Active Record Models</h3><p>It is very easy to create Active Record models. All you have to do is to
subclass the <code>ActiveRecord::Base</code> class and you're good to go:</p><div class="code_container">
<div><div id="highlighter_867243" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">Product &lt; ActiveRecord::Base</code></div><div class="line number2 index1 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>This will create a <code>Product</code> model, mapped to a <code>products</code> table at the
database. By doing this you'll also have the ability to map the columns of each
row in that table with the attributes of the instances of your model. Suppose
that the <code>products</code> table was created using an SQL sentence like:</p><div class="code_container">
<div><div id="highlighter_272185" class="syntaxhighlighter nogutter  sql"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">products (</code></div><div class="line number2 index1 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;</code><code class="sql plain">id </code><code class="sql keyword">int</code><code class="sql plain">(11) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql plain">auto_increment,</code></div><div class="line number3 index2 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;</code><code class="sql keyword">name</code> <code class="sql keyword">varchar</code><code class="sql plain">(255),</code></div><div class="line number4 index3 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;</code><code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code>&nbsp; <code class="sql plain">(id)</code></div><div class="line number5 index4 alt2"><code class="sql plain">);</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Following the table schema above, you would be able to write code like the
following:</p><div class="code_container">
<div><div id="highlighter_482088" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">p = Product.</code><code class="ruby keyword">new</code></div><div class="line number2 index1 alt1"><code class="ruby plain">p.name = </code><code class="ruby string">"Some Book"</code></div><div class="line number3 index2 alt2"><code class="ruby plain">puts p.name </code><code class="ruby comments"># "Some Book"</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3 id="overriding-the-naming-conventions">4 Overriding the Naming Conventions</h3><p>What if you need to follow a different naming convention or need to use your
Rails application with a legacy database? No problem, you can easily override
the default conventions.</p><p>You can use the <code>ActiveRecord::Base.table_name=</code> method to specify the table
name that should be used:</p><div class="code_container">
<div><div id="highlighter_88734" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">Product &lt; ActiveRecord::Base</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">self</code><code class="ruby plain">.table_name = </code><code class="ruby string">"my_products"</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>If you do so, you will have to define manually the class name that is hosting
the fixtures (my_products.yml) using the <code>set_fixture_class</code> method in your test
definition:</p><div class="code_container">
<div><div id="highlighter_931985" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">ProductTest &lt; ActiveSupport::TestCase</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">set_fixture_class my_products: Product</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">fixtures </code><code class="ruby color2">:my_products</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">...</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>It's also possible to override the column that should be used as the table's
primary key using the <code>ActiveRecord::Base.primary_key=</code> method:</p><div class="code_container">
<div><div id="highlighter_557431" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">Product &lt; ActiveRecord::Base</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">self</code><code class="ruby plain">.primary_key = </code><code class="ruby string">"product_id"</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3 id="crud-reading-and-writing-data">5 CRUD: Reading and Writing Data</h3><p>CRUD is an acronym for the four verbs we use to operate on data: <strong>C</strong>reate,
<strong>R</strong>ead, <strong>U</strong>pdate and <strong>D</strong>elete. Active Record automatically creates methods
to allow an application to read and manipulate data stored within its tables.</p><h4 id="create">5.1 Create</h4><p>Active Record objects can be created from a hash, a block or have their
attributes manually set after creation. The <code>new</code> method will return a new
object while <code>create</code> will return the object and save it to the database.</p><p>For example, given a model <code>User</code> with attributes of <code>name</code> and <code>occupation</code>,
the <code>create</code> method call will create and save a new record into the database:</p><div class="code_container">
<div><div id="highlighter_517785" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">user = User.create(name: </code><code class="ruby string">"David"</code><code class="ruby plain">, occupation: </code><code class="ruby string">"Code Artist"</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Using the <code>new</code> method, an object can be instantiated without being saved:</p><div class="code_container">
<div><div id="highlighter_663466" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">user = User.</code><code class="ruby keyword">new</code></div><div class="line number2 index1 alt1"><code class="ruby plain">user.name = </code><code class="ruby string">"David"</code></div><div class="line number3 index2 alt2"><code class="ruby plain">user.occupation = </code><code class="ruby string">"Code Artist"</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>A call to <code>user.save</code> will commit the record to the database.</p><p>Finally, if a block is provided, both <code>create</code> and <code>new</code> will yield the new
object to that block for initialization:</p><div class="code_container">
<div><div id="highlighter_184685" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">user = User.</code><code class="ruby keyword">new</code> <code class="ruby keyword">do</code> <code class="ruby plain">|u|</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">u.name = </code><code class="ruby string">"David"</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">u.occupation = </code><code class="ruby string">"Code Artist"</code></div><div class="line number4 index3 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="read">5.2 Read</h4><p>Active Record provides a rich API for accessing data within a database. Below
are a few examples of different data access methods provided by Active Record.</p><div class="code_container">
<div><div id="highlighter_911082" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby comments"># return a collection with all users</code></div><div class="line number2 index1 alt1"><code class="ruby plain">users = User.all</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="code_container">
<div><div id="highlighter_674950" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby comments"># return the first user</code></div><div class="line number2 index1 alt1"><code class="ruby plain">user = User.first</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="code_container">
<div><div id="highlighter_455212" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby comments"># return the first user named David</code></div><div class="line number2 index1 alt1"><code class="ruby plain">david = User.find_by(name: </code><code class="ruby string">'David'</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="code_container">
<div><div id="highlighter_445213" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby comments"># find all users named David who are Code Artists and sort by created_at in reverse chronological order</code></div><div class="line number2 index1 alt1"><code class="ruby plain">users = User.where(name: </code><code class="ruby string">'David'</code><code class="ruby plain">, occupation: </code><code class="ruby string">'Code Artist'</code><code class="ruby plain">).order(created_at: </code><code class="ruby color2">:desc</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>You can learn more about querying an Active Record model in the <a href="active_record_querying.html">Active Record
Query Interface</a> guide.</p><h4 id="update">5.3 Update</h4><p>Once an Active Record object has been retrieved, its attributes can be modified
and it can be saved to the database.</p><div class="code_container">
<div><div id="highlighter_183802" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">user = User.find_by(name: </code><code class="ruby string">'David'</code><code class="ruby plain">)</code></div><div class="line number2 index1 alt1"><code class="ruby plain">user.name = </code><code class="ruby string">'Dave'</code></div><div class="line number3 index2 alt2"><code class="ruby plain">user.save</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>A shorthand for this is to use a hash mapping attribute names to the desired
value, like so:</p><div class="code_container">
<div><div id="highlighter_894317" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">user = User.find_by(name: </code><code class="ruby string">'David'</code><code class="ruby plain">)</code></div><div class="line number2 index1 alt1"><code class="ruby plain">user.update(name: </code><code class="ruby string">'Dave'</code><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>This is most useful when updating several attributes at once. If, on the other
hand, you'd like to update several records in bulk, you may find the
<code>update_all</code> class method useful:</p><div class="code_container">
<div><div id="highlighter_322260" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">User.update_all </code><code class="ruby string">"max_login_attempts = 3, must_change_password = 'true'"</code></div></div></td></tr></tbody></table></div></div>
</div>
<h4 id="delete">5.4 Delete</h4><p>Likewise, once retrieved an Active Record object can be destroyed which removes
it from the database.</p><div class="code_container">
<div><div id="highlighter_420136" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">user = User.find_by(name: </code><code class="ruby string">'David'</code><code class="ruby plain">)</code></div><div class="line number2 index1 alt1"><code class="ruby plain">user.destroy</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3 id="validations">6 Validations</h3><p>Active Record allows you to validate the state of a model before it gets written
into the database. There are several methods that you can use to check your
models and validate that an attribute value is not empty, is unique and not
already in the database, follows a specific format and many more.</p><p>Validation is a very important issue to consider when persisting to the database, so
the methods <code>save</code> and <code>update</code> take it into account when
running: they return <code>false</code> when validation fails and they didn't actually
perform any operation on the database. All of these have a bang counterpart (that
is, <code>save!</code> and <code>update!</code>), which are stricter in that
they raise the exception <code>ActiveRecord::RecordInvalid</code> if validation fails.
A quick example to illustrate:</p><div class="code_container">
<div><div id="highlighter_131697" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">User &lt; ActiveRecord::Base</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby plain">validates </code><code class="ruby color2">:name</code><code class="ruby plain">, presence: </code><code class="ruby keyword">true</code></div><div class="line number3 index2 alt2"><code class="ruby keyword">end</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">user = User.</code><code class="ruby keyword">new</code></div><div class="line number6 index5 alt1"><code class="ruby plain">user.save&nbsp; </code><code class="ruby comments"># =&gt; false</code></div><div class="line number7 index6 alt2"><code class="ruby plain">user.save! </code><code class="ruby comments"># =&gt; ActiveRecord::RecordInvalid: Validation failed: Name can't be blank</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>You can learn more about validations in the <a href="active_record_validations.html">Active Record Validations
guide</a>.</p><h3 id="callbacks">7 Callbacks</h3><p>Active Record callbacks allow you to attach code to certain events in the
life-cycle of your models. This enables you to add behavior to your models by
transparently executing code when those events occur, like when you create a new
record, update it, destroy it and so on. You can learn more about callbacks in
the <a href="active_record_callbacks.html">Active Record Callbacks guide</a>.</p><h3 id="migrations">8 Migrations</h3><p>Rails provides a domain-specific language for managing a database schema called
migrations. Migrations are stored in files which are executed against any
database that Active Record supports using <code>rake</code>. Here's a migration that
creates a table:</p><div class="code_container">
<div><div id="highlighter_366383" class="syntaxhighlighter nogutter  ruby"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">class</code> <code class="ruby plain">CreatePublications &lt; ActiveRecord::Migration</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">change</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">create_table </code><code class="ruby color2">:publications</code> <code class="ruby keyword">do</code> <code class="ruby plain">|t|</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.string </code><code class="ruby color2">:title</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.text </code><code class="ruby color2">:description</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.references </code><code class="ruby color2">:publication_type</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.integer </code><code class="ruby color2">:publisher_id</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.string </code><code class="ruby color2">:publisher_type</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.boolean </code><code class="ruby color2">:single_issue</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">t.timestamps null: </code><code class="ruby keyword">false</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="ruby plain">add_index </code><code class="ruby color2">:publications</code><code class="ruby plain">, </code><code class="ruby color2">:publication_type_id</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number15 index14 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Rails keeps track of which files have been committed to the database and
provides rollback features. To actually create the table, you'd run <code>rake db:migrate</code>
and to roll it back, <code>rake db:rollback</code>.</p><p>Note that the above code is database-agnostic: it will run in MySQL,
PostgreSQL, Oracle and others. You can learn more about migrations in the
<a href="migrations.html">Active Record Migrations guide</a>.</p>

      </div>
    </div>
  </div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/11/how-to-deploy-a-rails-app-with-passenger-and-nginx-on-ubuntu-14-dot-04/">How to Deploy a Rails App With Passenger and Nginx on Ubuntu 14.04</a></h1>
    
    
      <p class="meta">
        








  





<time datetime="2015-12-11T15:05:29+07:00" pubdate data-updated="true"><time class='entry-date' datetime='2015-12-11T15:05:29+07:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:05 pm</span></time></time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="content-body tutorial-content" data-growable-markdown="">
      <div name="introduction" data-unique="introduction"></div><h2 id="introduction">Introduction</h2>

<p>If you are a Ruby on Rails developer, you probably need a web server to host your web apps. This tutorial shows you how to use <a href="https://www.phusionpassenger.com/">Phusion Passenger</a> as your Rails-friendly web server. Passenger is easy to install, configure, and maintain and it can be used with Nginx or Apache. In this tutorial, we will install Passenger with Nginx on Ubuntu 14.04.</p>

<p>An alternate method to deploy your Rails app is with this <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-1-click-ruby-on-rails-on-ubuntu-14-04-image">1-Click Rails Installation</a> that uses Nginx with <a href="http://unicorn.bogomips.org/">Unicorn</a>, a HTTP server that can handle multiple requests concurrently.</p>

<p>By the end of this tutorial, you will have a test Rails application deployed on your Passenger/Nginx web server and accessible via a domain or IP address.</p>

<div name="step-one-—-create-your-droplet" data-unique="step-one-—-create-your-droplet"></div><h2 id="step-one-—-create-your-droplet">Step One — Create Your Droplet</h2>

<p>Create a new Ubuntu 14.04 Droplet. For smaller sites, it is enough to take the 512 MB plan.</p>

<p class="growable"><img src="https://assets.digitalocean.com/articles/Rails_Passenger_Nginx/1.png" alt="Droplet size"></p>

<p>You may want to choose the 32-bit Ubuntu image because of smaller memory consumption (64-bit programs use about 50% more memory then their 32-bit counterparts). However, if you need a bigger machine or there is a chance that you will upgrade to more than 4 GB of RAM, you should choose the 64-bit version.</p>

<p class="growable"><img src="https://assets.digitalocean.com/articles/Rails_Passenger_Nginx/2.png" alt="Droplet image"></p>

<div name="step-two-—-add-a-sudo-user" data-unique="step-two-—-add-a-sudo-user"></div><h2 id="step-two-—-add-a-sudo-user">Step Two — Add a Sudo User</h2>

<p>After the Droplet is created, additional system administration work is needed. You should create a system user and secure the server.</p>

<p>Follow the <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-14-04">Initial Server Setup</a> article.</p>

<p>In this tutorial, you should create a basic user with sudo privileges. We will use the <em>rails</em> user in this example. If your user has another name, make sure that you use correct paths in the next steps.</p>

<div name="step-three-(optional)-—-set-up-your-domain" data-unique="step-three-(optional)-—-set-up-your-domain"></div><h2 id="step-three-optional-—-set-up-your-domain">Step Three (Optional) — Set Up Your Domain</h2>

<p>In order to ensure that your site will be up and visible, you need to set up your DNS records to point your domain name towards your new server. You can find more information on <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-host-name-with-digitalocean">setting up a hostname</a> by following the link.</p>

<p>However, this step is optional, since you can access your site via an IP address.</p>

<div name="step-four-—-install-ruby" data-unique="step-four-—-install-ruby"></div><h2 id="step-four-—-install-ruby">Step Four — Install Ruby</h2>

<p>We will install Ruby manually from source.</p>

<p>Before we do anything else, we should run an update to make sure that all of the packages we want to install are up to date:</p>
<pre class="code-pre "><code langs="">sudo apt-get update
</code></pre>
<p>Next, install some dependencies. This should make the installation as smooth as possible:</p>
<pre class="code-pre "><code langs="">sudo apt-get install build-essential libssl-dev libyaml-dev libreadline-dev openssl curl git-core zlib1g-dev bison libxml2-dev libxslt1-dev libcurl4-openssl-dev nodejs libsqlite3-dev sqlite3
</code></pre>
<p>Create a temporary folder for the Ruby source files:</p>
<pre class="code-pre "><code langs="">mkdir ~/ruby
</code></pre>
<p>Move to the new folder:</p>
<pre class="code-pre "><code langs="">cd ~/ruby
</code></pre>
<p>Download the latest stable Ruby source code. At the time of this writing, this is version 2.1.3. You can get the current latest version from the <a href="https://www.ruby-lang.org/en/downloads/">Download Ruby</a> website. If a newer version is available, you will need to replace the link in the following command:</p>
<pre class="code-pre "><code langs="">wget http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.3.tar.gz
</code></pre>
<p>Decompress the downloaded file:</p>
<pre class="code-pre "><code langs="">tar -xzf ruby-2.1.3.tar.gz
</code></pre>
<p>Select the extracted directory:</p>
<pre class="code-pre "><code langs="">cd ruby-2.1.3
</code></pre>
<p>Run the <span class="highlight-key-word">configure</span> script. This will take some time as it checks for dependencies and creates a new <strong>Makefile</strong>, which will contain steps that need to be taken to compile the code:</p>
<pre class="code-pre "><code langs="">./configure
</code></pre>
<p>Run the <span class="highlight-key-word">make</span> utility which will use the Makefile to build the executable program. This step can take a bit longer:</p>
<pre class="code-pre "><code langs="">make
</code></pre>
<p>Now, run the same command with the <span class="highlight-key-word">install</span> parameter. It will try to copy the compiled binaries to the <code>/usr/local/bin</code> folder. This step requires root access to write to this directory. It will also take a bit of time:</p>
<pre class="code-pre "><code langs="">sudo make install
</code></pre>
<p>Ruby should now be installed on the system. We can check it with the following command, which should print the Ruby version:</p>
<pre class="code-pre "><code langs="">ruby -v
</code></pre>
<p>Finally, we can delete the temporary folder:</p>
<pre class="code-pre "><code langs="">rm -rf ~/ruby
</code></pre>
<div name="step-five-—-install-passenger-and-nginx" data-unique="step-five-—-install-passenger-and-nginx"></div><h2 id="step-five-—-install-passenger-and-nginx">Step Five — Install Passenger and Nginx</h2>

<p>The preferred method to install Passenger in the past was using a generic installation via RubyGems (<code>passenger-install-nginx-module</code>).</p>

<p>However, you can now install Passenger on Ubuntu with the Advanced Packaging Tool (APT), which is what we'll be using. In this manner, the installation and — even more importantly — the update process for Passenger with Nginx, is really simple.</p>

<p>First, install a PGP key:</p>
<pre class="code-pre "><code langs="">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 561F9B9CAC40B2F7
</code></pre>
<p>Create an APT source file (you will need sudo privileges):</p>
<pre class="code-pre "><code langs="">sudo nano /etc/apt/sources.list.d/passenger.list
</code></pre>
<p>And insert the following line in the file:</p>
<pre class="code-pre "><code langs="">deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main
</code></pre>
<p>Press <strong>CTRL+x</strong> to exit, type <strong>y</strong> to save the file, and then press <strong>ENTER</strong> to confirm the file location.</p>

<p>Change the owner and permissions for this file:</p>
<pre class="code-pre "><code langs="">sudo chown root: /etc/apt/sources.list.d/passenger.list
sudo chmod 600 /etc/apt/sources.list.d/passenger.list
</code></pre>
<p>Update the APT cache:</p>
<pre class="code-pre "><code langs="">sudo apt-get update
</code></pre>
<p>Finally, install Passenger with Nginx:</p>
<pre class="code-pre "><code langs="">sudo apt-get install nginx-extras passenger
</code></pre>
<p>This step will overwrite our Ruby version to an older one. To resolve this, simply remove the incorrect Ruby location and create a new symlink to the correct Ruby binary file:</p>
<pre class="code-pre "><code langs="">sudo rm /usr/bin/ruby
sudo ln -s /usr/local/bin/ruby /usr/bin/ruby
</code></pre>
<div name="step-six-—-set-up-the-web-server" data-unique="step-six-—-set-up-the-web-server"></div><h2 id="step-six-—-set-up-the-web-server">Step Six — Set Up The Web Server</h2>

<p>Open the Nginx configuration file:</p>
<pre class="code-pre "><code langs="">sudo nano /etc/nginx/nginx.conf
</code></pre>
<p>Find the following lines, in the <span class="highlight-key-word">http</span> block:</p>
<pre class="code-pre "><code langs=""># passenger_root /usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini;
# passenger_ruby /usr/bin/ruby;
</code></pre>
<p>Uncomment both of them. Update the path in the <span class="highlight-key-word">passenger_ruby</span> line. They should look like this:</p>
<pre class="code-pre "><code langs="">passenger_root /usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini;
passenger_ruby /usr/local/bin/ruby;
</code></pre>
<p>Save and exit the file.</p>

<div name="step-seven-—-deploy" data-unique="step-seven-—-deploy"></div><h2 id="step-seven-—-deploy">Step Seven — Deploy</h2>

<p>At this point you can deploy your own Rails application if you have one ready. If you want to deploy an existing app, you can upload your project to the server and skip to the <code>/etc/nginx/sites-available/default</code> step.</p>

<p>For this tutorial, we will create a new Rails app directly on the Droplet. We will need a the <strong>rails</strong> gem to create the new app.</p>

<p>Move to your user's home directory (otherwise, you will get the error <code>No such file or directory - getcwd</code>) –</p>
<pre class="code-pre "><code langs="">cd ~
</code></pre>
<p>Install the <strong>rails</strong> gem (without extra documentation to install it faster). This will still take a few minutes:</p>
<pre class="code-pre "><code langs="">sudo gem install --no-rdoc --no-ri rails
</code></pre>
<p>Now we can create a new app. In our example, we will use the name <span class="highlight-key-word">testapp</span>. If you want to use another name, make sure you use correct paths. We will skip the Bundler installation because we want to run it manually later.</p>
<pre class="code-pre "><code langs="">rails new testapp --skip-bundle
</code></pre>
<p>Enter the directory:</p>
<pre class="code-pre "><code langs="">cd testapp
</code></pre>
<p>Now we need to install a JavaScript execution environment. It can be installed as the <span class="highlight-key-word">therubyracer</span> gem. To install it, open the <strong>Gemfile</strong>:</p>
<pre class="code-pre "><code langs="">nano Gemfile
</code></pre>
<p>Find the following line:</p>
<pre class="code-pre "><code langs=""># gem 'therubyracer',  platforms: :ruby
</code></pre>
<p>And uncomment it:</p>
<pre class="code-pre "><code langs="">gem 'therubyracer',  platforms: :ruby
</code></pre>
<p>Save the file, and run Bundler:</p>
<pre class="code-pre "><code langs="">bundle install
</code></pre>
<p>We need to disable the default Nginx configuration. Open the Nginx config file:</p>
<pre class="code-pre "><code langs="">sudo nano /etc/nginx/sites-available/default
</code></pre>
<p>Find the lines:</p>
<pre class="code-pre "><code langs="">listen 80 default_server;
listen [::]:80 default_server ipv6only=on;
</code></pre>
<p>Comment them out, like this:</p>
<pre class="code-pre "><code langs=""># listen 80 default_server;
# listen [::]:80 default_server ipv6only=on;
</code></pre>
<p>Save the file.</p>

<p>Now, create an Nginx configuration file for our app:</p>
<pre class="code-pre "><code langs="">sudo nano /etc/nginx/sites-available/testapp
</code></pre>
<p>Add the following <code>server</code> block. The settings are explained below.</p>
<pre class="code-pre "><code langs="">server {
  listen 80 default_server;
  server_name <span class="highlight-key-word">www.mydomain.com</span>;
  passenger_enabled on;
  passenger_app_env development;
  root <span class="highlight-key-word">/home/rails/testapp/public</span>;
}
</code></pre>
<p>In this file, we enable listening on port 80, set your domain name, enable Passenger, and set the root to the <em>public</em> directory of our new project. The <span class="highlight-key-word">root</span> line is the one you'll want to edit to match the upload location of your Rails app.</p>

<p>If you don't want to assign your domain to this app, you can skip the <span class="highlight-key-word">server_name</span> line, or use your IP address.</p>

<p>To test our setup, we want to see the Rails <strong>Welcome aboard</strong> page. However, this works only if the application is started in the development environment. Passenger starts the application in the production environment by default, so we need to change this with the <code>passenger_app_env</code> option. If your app is ready for production you'll want to leave this setting out.</p>

<p>Save the file (<strong>CTRL+x</strong>, <strong>y</strong>, <strong>ENTER</strong>).</p>

<p>Create a symlink for it:</p>
<pre class="code-pre "><code langs="">sudo ln -s /etc/nginx/sites-available/testapp /etc/nginx/sites-enabled/testapp
</code></pre>
<p>Restart Nginx:</p>
<pre class="code-pre "><code langs="">sudo nginx -s reload
</code></pre>
<p>Now your app's website should be accessible. Navigate to your Droplet's domain or IP address:</p>
<pre class="code-pre "><code langs="">http://droplet_ip_address
</code></pre>
<p>And verify the result:</p>

<p class="growable"><img src="https://assets.digitalocean.com/articles/Rails_Passenger_Nginx/3.png" alt="Test page"></p>

<p>You should see the Rails test app live on your server.</p>

<div name="step-eight-—-update-regularly" data-unique="step-eight-—-update-regularly"></div><h2 id="step-eight-—-update-regularly">Step Eight — Update Regularly</h2>

<p>To update Ruby, you will need to compile the latest version as shown in Step Four in this tutorial.</p>

<p>To update Passenger with Nginx, you will need to run a basic system update:</p>
<pre class="code-pre "><code langs="">sudo apt-get update &amp;&amp; sudo apt-get upgrade
</code></pre>
<p>However, if there is a new system Ruby version available, it will probably overwrite our Ruby (installed from source). For this reason, you might need to re-run the commands for removing the existing version of Ruby and creating a new symlink to the Ruby binary file. They are listed at the end of Step Five in this tutorial.</p>

<p>After the update process, you will need to restart the web server:</p>
<pre class="code-pre "><code langs="">sudo service nginx restart
</code></pre>
    </div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  <img alt="Headshot" id="headshot" src="/images/my-profile.jpg">
  <p class="about-me-description">Doundara Keut, Professional <b> Web/DB Developer</b> and <b>Software Engineer Full Stack Achitecture</b> building <b>Enterprise-Level Applications</b> as well as websites for the <b>Small Business Owner</b>.</p>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/12/11/active-record-basic/">Active Record Basic</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/11/how-to-deploy-a-rails-app-with-passenger-and-nginx-on-ubuntu-14-dot-04/">How To Deploy a Rails App with Passenger and Nginx on Ubuntu 14.04</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/doungdara">@doungdara</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'doungdara',
            count: 15,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/110026092726784890051?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Doungdara Keut -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
